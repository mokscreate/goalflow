<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>GOALflow</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --black: #0f0f0f;
  --white: #f5f4f0;
  --gray-100: #eeede9;
  --gray-200: #dddcd8;
  --gray-400: #999890;
  --gray-600: #666560;
  --border: #e0dfd9;
  --green: #3d6b4f;
  --green-light: #e8f0eb;
  --green-border: #c5dac9;
  --red: #c0392b;
  --red-light: #fdf0ee;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  background: var(--white);
  color: var(--black);
  font-family: 'Noto Sans SC', sans-serif;
  font-weight: 300;
  line-height: 1.6;
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€ NAV â”€â”€ */
nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 20px;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--white);
  z-index: 100;
}
.logo { font-family: 'DM Serif Display', serif; font-size: 18px; letter-spacing: 0.05em; }
.logo em { font-style: italic; color: var(--gray-600); }
.nav-right { display: flex; align-items: center; gap: 12px; }
.nav-hint { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--gray-400); letter-spacing: 0.08em; }
.btn-settings {
  background: none; border: 1px solid var(--border); border-radius: 6px;
  padding: 4px 10px; font-size: 11px; font-family: 'DM Mono', monospace;
  color: var(--gray-600); cursor: pointer;
}

/* â”€â”€ PAGES â”€â”€ */
.page { display: none; animation: fadeUp 0.25s ease; }
.page.active { display: block; }
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* â”€â”€ BOTTOM TABS â”€â”€ */
.bottom-tabs {
  position: fixed; bottom: 0; left: 0; right: 0;
  height: 58px; background: var(--white);
  border-top: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-around;
  z-index: 200;
}
.tab-btn {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  padding: 6px 20px; cursor: pointer; border: none; background: none;
  color: var(--gray-400); transition: color 0.15s;
}
.tab-btn.active { color: var(--black); }
.tab-icon { font-size: 17px; }
.tab-label { font-size: 10px; font-family: 'DM Mono', monospace; letter-spacing: 0.04em; }

/* â”€â”€ SHARED COMPONENTS â”€â”€ */
.page-wrap { padding: 36px 20px 100px; max-width: 520px; margin: 0 auto; }
.mono-label { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.14em; color: var(--gray-400); text-transform: uppercase; margin-bottom: 28px; }
.serif-title { font-family: 'DM Serif Display', serif; font-size: 30px; line-height: 1.25; margin-bottom: 6px; }
.serif-title em { font-style: italic; color: var(--gray-600); }
.body-sub { font-size: 13px; color: var(--gray-600); margin-bottom: 36px; }

.field-group { margin-bottom: 22px; }
.field-label { font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.1em; color: var(--gray-600); margin-bottom: 8px; display: block; }
.field-input {
  width: 100%; border: 1px solid var(--border); border-radius: 8px;
  padding: 13px 15px; font-family: 'Noto Sans SC', sans-serif;
  font-size: 15px; font-weight: 300; color: var(--black);
  background: var(--white); outline: none; transition: border-color 0.2s;
  -webkit-appearance: none;
}
.field-input:focus { border-color: var(--black); }
.field-input::placeholder { color: var(--gray-400); }
textarea.field-input { resize: none; height: 96px; }

.chips { display: flex; gap: 7px; flex-wrap: wrap; }
.chip {
  padding: 7px 14px; border: 1px solid var(--border); border-radius: 20px;
  font-size: 12px; font-family: 'DM Mono', monospace; cursor: pointer;
  transition: all 0.15s; background: var(--white); color: var(--gray-600);
}
.chip.sel { background: var(--black); color: var(--white); border-color: var(--black); }

.ai-tip {
  background: var(--green-light); border: 1px solid var(--green-border);
  border-radius: 8px; padding: 12px 14px; margin-top: 10px;
  display: flex; gap: 10px; align-items: flex-start;
}
.ai-tip-icon { font-size: 13px; flex-shrink: 0; margin-top: 2px; color: var(--green); }
.ai-tip-text { font-size: 13px; color: var(--green); line-height: 1.55; }
.ai-tip-text strong { font-weight: 500; }

.btn-primary {
  width: 100%; padding: 15px; background: var(--black); color: var(--white);
  border: none; border-radius: 10px; font-size: 15px;
  font-family: 'Noto Sans SC', sans-serif; font-weight: 400;
  cursor: pointer; letter-spacing: 0.03em; transition: opacity 0.15s;
  margin-top: 28px; position: relative;
}
.btn-primary:active { opacity: 0.8; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-secondary {
  width: 100%; padding: 14px; background: transparent; color: var(--black);
  border: 1px solid var(--border); border-radius: 10px; font-size: 14px;
  font-family: 'Noto Sans SC', sans-serif; cursor: pointer; margin-top: 10px;
}

.loading-dots::after {
  content: ''; animation: dots 1.2s infinite;
}
@keyframes dots {
  0%,20% { content: ''; }
  40% { content: '.'; }
  60% { content: '..'; }
  80%,100% { content: '...'; }
}

.error-box {
  background: var(--red-light); border: 1px solid #f0c8c4;
  border-radius: 8px; padding: 12px 14px; margin-top: 12px;
  font-size: 13px; color: var(--red); line-height: 1.55;
}

/* â”€â”€ PAGE: INPUT â”€â”€ */
.time-custom { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
.time-custom input {
  width: 60px; border: 1px solid var(--border); border-radius: 6px;
  padding: 7px 10px; font-family: 'DM Mono', monospace; font-size: 13px;
  text-align: center; outline: none; background: var(--white); color: var(--black);
}
.time-custom span { font-size: 13px; color: var(--gray-600); }

/* â”€â”€ PAGE: OUTLINE â”€â”€ */
.meta-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
.meta-tag { font-family: 'DM Mono', monospace; font-size: 11px; padding: 3px 9px; background: var(--gray-100); border-radius: 4px; color: var(--gray-600); }

.phase-card {
  border: 1px solid var(--border); border-radius: 12px;
  padding: 18px; margin-bottom: 10px; background: var(--white);
}
.phase-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.phase-num { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--gray-400); letter-spacing: 0.1em; }
.phase-days-badge { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--gray-600); background: var(--gray-100); padding: 2px 8px; border-radius: 4px; }
.phase-name { font-size: 15px; font-weight: 500; margin-bottom: 5px; }
.phase-desc { font-size: 13px; color: var(--gray-600); line-height: 1.6; }
.phase-topics { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
.topic-tag { font-size: 11px; padding: 2px 8px; border: 1px solid var(--border); border-radius: 4px; color: var(--gray-600); font-family: 'DM Mono', monospace; }

.outline-note {
  margin-top: 18px; padding: 14px; border: 1px dashed var(--border); border-radius: 10px;
}
.outline-note-label { font-size: 11px; color: var(--gray-400); font-family: 'DM Mono', monospace; margin-bottom: 5px; }
.outline-note-text { font-size: 13px; color: var(--gray-600); line-height: 1.6; }

/* â”€â”€ PAGE: DAILY â”€â”€ */
.progress-wrap { padding: 20px 20px 0; }
.progress-head { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
.progress-goal-title { font-family: 'DM Serif Display', serif; font-size: 20px; }
.progress-frac { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--gray-600); }
.progress-track { height: 3px; background: var(--gray-200); border-radius: 2px; overflow: hidden; margin-bottom: 4px; }
.progress-fill { height: 100%; background: var(--black); border-radius: 2px; transition: width 0.5s ease; }
.progress-sub { font-size: 11px; color: var(--gray-400); font-family: 'DM Mono', monospace; }

.day-scroll {
  display: flex; gap: 7px; padding: 18px 20px 0;
  overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none;
}
.day-scroll::-webkit-scrollbar { display: none; }
.day-btn {
  flex-shrink: 0; display: flex; flex-direction: column; align-items: center;
  width: 50px; padding: 10px 0; border: 1px solid var(--border);
  border-radius: 10px; cursor: pointer; background: var(--white);
  transition: all 0.15s; gap: 3px;
}
.day-btn.cur { background: var(--black); border-color: var(--black); }
.day-btn.done { border-color: var(--green); }
.day-num-text { font-family: 'DM Mono', monospace; font-size: 15px; color: var(--gray-600); }
.day-btn.cur .day-num-text { color: var(--white); }
.day-btn.done .day-num-text { color: var(--green); }
.day-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--gray-200); }
.day-btn.done .day-dot { background: var(--green); }
.day-btn.cur .day-dot { background: rgba(255,255,255,0.35); }

.divider { display: flex; align-items: center; gap: 10px; margin: 20px 20px 0; }
.divider-line { flex: 1; height: 1px; background: var(--border); }
.divider-text { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--gray-400); letter-spacing: 0.1em; text-transform: uppercase; }

.tasks-wrap { padding: 20px 20px 0; }
.tasks-day-head { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
.tasks-day-title { font-family: 'DM Serif Display', serif; font-size: 22px; }
.tasks-day-phase { font-size: 11px; color: var(--gray-400); font-family: 'DM Mono', monospace; }
.tasks-day-desc { font-size: 13px; color: var(--gray-600); margin-bottom: 18px; line-height: 1.55; }

.task-item {
  display: flex; gap: 14px; padding: 15px 0;
  border-bottom: 1px solid var(--border); align-items: flex-start; cursor: pointer;
}
.task-item:last-child { border-bottom: none; }
.task-check {
  width: 22px; height: 22px; border: 1.5px solid var(--gray-200);
  border-radius: 50%; flex-shrink: 0; margin-top: 1px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.task-item.done .task-check { background: var(--black); border-color: var(--black); }
.check-mark { display: none; color: white; font-size: 11px; font-weight: 600; }
.task-item.done .check-mark { display: block; }
.task-body { flex: 1; }
.task-title { font-size: 14px; color: var(--black); margin-bottom: 3px; transition: color 0.2s; line-height: 1.5; }
.task-item.done .task-title { color: var(--gray-400); text-decoration: line-through; }
.task-est { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--gray-400); }
.task-tag {
  font-size: 10px; padding: 2px 7px; background: var(--gray-100);
  border-radius: 3px; color: var(--gray-600); margin-top: 5px;
  display: inline-block; font-family: 'DM Mono', monospace;
}
.spacer { height: 160px; }

/* FAB */
.fab {
  position: fixed; bottom: 66px; left: 50%; transform: translateX(-50%);
  width: calc(100% - 40px); max-width: 480px; z-index: 150;
}
.fab-inner {
  background: var(--black); color: var(--white); padding: 14px 18px;
  border-radius: 12px; display: flex; align-items: center;
  justify-content: space-between; gap: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.18);
}
.fab-text { font-size: 13px; line-height: 1.4; flex: 1; }
.fab-text strong { font-weight: 500; }
.fab-text small { display: block; font-size: 11px; opacity: 0.55; font-family: 'DM Mono', monospace; margin-top: 1px; }
.fab-action {
  background: white; color: var(--black); border: none; border-radius: 7px;
  padding: 8px 14px; font-size: 12px; font-weight: 500; cursor: pointer;
  white-space: nowrap; font-family: 'Noto Sans SC', sans-serif;
}

/* â”€â”€ PAGE: SETTINGS â”€â”€ */
.settings-section { margin-bottom: 28px; }
.settings-title { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.14em; color: var(--gray-400); text-transform: uppercase; margin-bottom: 12px; }
.settings-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 0; border-bottom: 1px solid var(--border);
}
.settings-row:last-child { border-bottom: none; }
.settings-row-label { font-size: 14px; }
.settings-row-sub { font-size: 12px; color: var(--gray-400); margin-top: 2px; font-family: 'DM Mono', monospace; }

/* â”€â”€ PAGE: HOME (plan list) â”€â”€ */
.plan-card {
  border: 1px solid var(--border); border-radius: 12px; padding: 18px;
  margin-bottom: 10px; cursor: pointer; transition: border-color 0.15s;
}
.plan-card:active { border-color: var(--gray-400); }
.plan-card-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.plan-card-title { font-size: 15px; font-weight: 500; line-height: 1.4; flex: 1; padding-right: 10px; }
.plan-card-date { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--gray-400); }
.plan-progress-mini { height: 3px; background: var(--gray-200); border-radius: 2px; overflow: hidden; margin-bottom: 6px; }
.plan-progress-mini-fill { height: 100%; background: var(--black); border-radius: 2px; }
.plan-progress-label { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--gray-600); }
.plan-card-del {
  background: none; border: none; color: var(--gray-400); font-size: 12px;
  cursor: pointer; padding: 2px 6px; font-family: 'DM Mono', monospace;
  margin-top: 10px;
}

.empty-state { text-align: center; padding: 60px 20px; }
.empty-icon { font-size: 36px; margin-bottom: 16px; }
.empty-title { font-family: 'DM Serif Display', serif; font-size: 22px; margin-bottom: 8px; }
.empty-sub { font-size: 13px; color: var(--gray-600); margin-bottom: 28px; }
.btn-start {
  display: inline-block; padding: 13px 28px; background: var(--black);
  color: var(--white); border: none; border-radius: 10px; font-size: 14px;
  font-family: 'Noto Sans SC', sans-serif; cursor: pointer;
}


/* â”€â”€ BOTTOM SHEET â”€â”€ */
.sheet-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.45);
  z-index: 500; display: flex; align-items: flex-end;
  animation: fadeIn 0.2s ease;
}
.sheet-overlay.hidden { display: none; }
.sheet {
  background: var(--white); border-radius: 20px 20px 0 0;
  width: 100%; max-height: 85vh; overflow-y: auto;
  animation: slideUp 0.28s ease; padding-bottom: 40px;
}
.sheet-handle {
  width: 36px; height: 4px; background: var(--gray-200);
  border-radius: 2px; margin: 12px auto 0;
}
.sheet-header {
  padding: 16px 20px 0;
  display: flex; align-items: flex-start; justify-content: space-between; gap: 12px;
}
.sheet-title { font-family: 'DM Serif Display', serif; font-size: 22px; line-height: 1.3; flex: 1; }
.sheet-close {
  background: var(--gray-100); border: none; border-radius: 50%;
  width: 30px; height: 30px; font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  color: var(--gray-600);
}
.sheet-body { padding: 16px 20px 0; }
.sheet-section { margin-bottom: 20px; }
.sheet-section-label {
  font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.12em;
  color: var(--gray-400); text-transform: uppercase; margin-bottom: 8px;
}
.sheet-section-text { font-size: 14px; color: var(--gray-600); line-height: 1.7; }
.sheet-section-text strong { color: var(--black); font-weight: 500; }

/* chat in sheet */
.sheet-chat { border-top: 1px solid var(--border); margin-top: 4px; padding-top: 16px; }
.sheet-chat-label {
  font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.12em;
  color: var(--gray-400); text-transform: uppercase; margin-bottom: 10px;
}
.chat-messages { margin-bottom: 12px; display: flex; flex-direction: column; gap: 10px; }
.chat-msg {
  padding: 10px 13px; border-radius: 10px; font-size: 13px; line-height: 1.6; max-width: 88%;
}
.chat-msg.ai { background: var(--gray-100); color: var(--black); align-self: flex-start; border-radius: 4px 10px 10px 10px; }
.chat-msg.user { background: var(--black); color: var(--white); align-self: flex-end; border-radius: 10px 10px 4px 10px; }
.chat-input-row { display: flex; gap: 8px; }
.chat-input {
  flex: 1; border: 1px solid var(--border); border-radius: 8px;
  padding: 10px 13px; font-size: 14px; font-family: 'Noto Sans SC', sans-serif;
  outline: none; background: var(--white); color: var(--black);
}
.chat-input:focus { border-color: var(--black); }
.chat-send {
  background: var(--black); color: var(--white); border: none;
  border-radius: 8px; padding: 10px 14px; font-size: 13px; cursor: pointer;
  white-space: nowrap; font-family: 'Noto Sans SC', sans-serif;
}
.chat-send:disabled { opacity: 0.5; }

/* task detail */
.resource-link {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px; border: 1px solid var(--border); border-radius: 8px;
  margin-bottom: 8px; text-decoration: none; color: var(--black);
  transition: border-color 0.15s;
}
.resource-link:active { border-color: var(--gray-400); }
.resource-link-icon { font-size: 18px; flex-shrink: 0; }
.resource-link-body { flex: 1; }
.resource-link-title { font-size: 14px; font-weight: 400; margin-bottom: 2px; }
.resource-link-url { font-size: 11px; color: var(--gray-400); font-family: 'DM Mono', monospace; }
.resource-link-arrow { color: var(--gray-400); font-size: 14px; }

.sheet-loading { text-align: center; padding: 32px 0; color: var(--gray-400); font-size: 13px; }
.sheet-loading-spin {
  width: 24px; height: 24px; border: 2px solid var(--gray-200);
  border-top-color: var(--black); border-radius: 50%;
  animation: spin 0.8s linear infinite; margin: 0 auto 12px;
}

/* phase card clickable */
.phase-card { cursor: pointer; transition: border-color 0.15s, box-shadow 0.15s; }
.phase-card:active { border-color: var(--gray-400); }
.phase-card-arrow { color: var(--gray-400); font-size: 13px; margin-top: 8px; font-family: 'DM Mono', monospace; }

/* task item detail button */
.task-detail-btn {
  background: none; border: none; color: var(--gray-400); font-size: 11px;
  font-family: 'DM Mono', monospace; cursor: pointer; padding: 0; margin-top: 4px;
  letter-spacing: 0.05em;
}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.4);
  display: flex; align-items: flex-end; z-index: 500;
  animation: fadeIn 0.2s ease;
}
.modal-overlay.hidden { display: none; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal-sheet {
  background: var(--white); border-radius: 16px 16px 0 0;
  padding: 28px 20px 40px; width: 100%;
  animation: slideUp 0.25s ease;
}
@keyframes slideUp { from { transform: translateY(40px); } to { transform: translateY(0); } }
.modal-title { font-family: 'DM Serif Display', serif; font-size: 22px; margin-bottom: 6px; }
.modal-sub { font-size: 13px; color: var(--gray-600); margin-bottom: 20px; }

/* â”€â”€ LOADING OVERLAY â”€â”€ */
.loading-overlay {
  position: fixed; inset: 0; background: var(--white);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  z-index: 600;
}
.loading-overlay.hidden { display: none; }
.loading-spinner {
  width: 32px; height: 32px; border: 2px solid var(--gray-200);
  border-top-color: var(--black); border-radius: 50%;
  animation: spin 0.8s linear infinite; margin-bottom: 20px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-msg { font-family: 'DM Serif Display', serif; font-size: 20px; margin-bottom: 6px; }
.loading-sub { font-size: 13px; color: var(--gray-600); }

/* â”€â”€ PRE-QUESTIONS â”€â”€ */
.prq-block { margin-bottom: 22px; }
.prq-label { font-size: 14px; font-weight: 500; margin-bottom: 10px; line-height: 1.5; }
.prq-chips { display: flex; gap: 7px; flex-wrap: wrap; }
.prq-chip {
  padding: 8px 14px; border: 1px solid var(--border); border-radius: 20px;
  font-size: 13px; cursor: pointer; transition: all 0.15s;
  background: var(--white); color: var(--gray-600);
}
.prq-chip.sel { background: var(--black); color: var(--white); border-color: var(--black); }
.prq-divider { height: 1px; background: var(--border); margin: 20px 0; }
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="logo">GOAL<em>flow</em></div>
  <div class="nav-right">
    <button class="btn-settings" onclick="showPage('settings')">è®¾ç½®</button>
  </div>
</nav>

<!-- LOADING OVERLAY -->
<div class="loading-overlay hidden" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-msg" id="loadingMsg">AI æ­£åœ¨è§„åˆ’</div>
  <div class="loading-sub" id="loadingSub">é€šå¸¸éœ€è¦ 10ï½20 ç§’</div>
</div>

<!-- â•â•â• PAGE: HOME â•â•â• -->
<div class="page active" id="page-home">
  <div class="page-wrap">
    <div class="mono-label">æˆ‘çš„è®¡åˆ’</div>
    <div id="planList"></div>
  </div>
</div>

<!-- â•â•â• PAGE: INPUT â•â•â• -->
<div class="page" id="page-input">
  <!-- STEP 1: è¾“å…¥ç›®æ ‡ -->
  <div id="inputStep1">
    <div class="page-wrap">
      <div class="mono-label">åˆ›å»ºæ–°è®¡åˆ’</div>
      <h1 class="serif-title">ä½ æƒ³<em>å­¦ä¼š</em><br>ä»€ä¹ˆï¼Ÿ</h1>
      <p class="body-sub">å‘Šè¯‰ AI ä½ çš„ç›®æ ‡ï¼Œå®ƒæ¥å¸®ä½ è¯„ä¼°æ—¶é—´å’Œåˆ¶å®šè®¡åˆ’</p>
      <div class="field-group">
        <label class="field-label">å­¦ä¹ ç›®æ ‡</label>
        <textarea class="field-input" id="inputGoal" placeholder="ä¾‹å¦‚ï¼šå­¦ä¼š Python åŸºç¡€ï¼Œèƒ½å†™ç®€å•çš„æ•°æ®å¤„ç†è„šæœ¬" style="height:110px;"></textarea>
      </div>
      <div class="error-box" id="inputError" style="display:none"></div>
      <button class="btn-primary" id="btnAnalyze" onclick="analyzeGoal()">AI å¸®æˆ‘è¯„ä¼°æ—¶é—´ â†’</button>
    </div>
  </div>

  <!-- STEP 2: AI å»ºè®® + å‰ç½®é—®é¢˜ -->
  <div id="inputStep2" style="display:none">
    <div class="page-wrap">
      <div class="mono-label">AI è¯„ä¼°ç»“æœ</div>

      <!-- AI æ—¶é—´å»ºè®®å¡ç‰‡ -->
      <div id="aiAdviceCard" style="border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:28px;">
        <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--gray-400);letter-spacing:0.12em;margin-bottom:10px;">AI å»ºè®®</div>
        <div id="aiAdviceText" style="font-size:14px;color:var(--black);line-height:1.7;"></div>
        <div style="display:flex;gap:16px;margin-top:14px;flex-wrap:wrap;" id="aiAdviceBadges"></div>
      </div>

      <!-- å‰ç½®é—®é¢˜ -->
      <div id="preQuestions"></div>

      <!-- æ—¶é—´ç¡®è®¤ -->
      <div style="margin-bottom:22px;">
        <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--gray-600);margin-bottom:8px;letter-spacing:0.08em;">ç¡®è®¤è®¡åˆ’æ—¶é•¿</div>
        <div class="chips" id="timeChips">
          <div class="chip" data-val="3">3å¤©</div>
          <div class="chip sel" data-val="7">1å‘¨</div>
          <div class="chip" data-val="14">2å‘¨</div>
          <div class="chip" data-val="30">1ä¸ªæœˆ</div>
        </div>
        <div class="time-custom">
          <span>æˆ–ç²¾ç¡®åˆ°</span>
          <input type="number" id="customDays" value="7" min="1" max="365">
          <span>å¤©</span>
        </div>
      </div>

      <div style="margin-bottom:28px;">
        <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--gray-600);margin-bottom:8px;letter-spacing:0.08em;">æ¯å¤©å¯ç”¨æ—¶é—´</div>
        <div class="chips" id="timePerDayChips">
          <div class="chip" data-val="0.5">30åˆ†é’Ÿ</div>
          <div class="chip sel" data-val="1">1å°æ—¶</div>
          <div class="chip" data-val="1.5">1.5å°æ—¶</div>
          <div class="chip" data-val="2">2å°æ—¶+</div>
        </div>
      </div>

      <div class="error-box" id="inputError2" style="display:none"></div>
      <button class="btn-primary" id="btnGenOutline" onclick="generateOutline()">ç”Ÿæˆå­¦ä¹ å¤§çº² â†’</button>
      <button class="btn-secondary" onclick="backToStep1()">é‡æ–°å¡«å†™ç›®æ ‡</button>
    </div>
  </div>
</div>

<!-- â•â•â• PAGE: OUTLINE â•â•â• -->
<div class="page" id="page-outline">
  <div class="page-wrap">
    <div class="meta-row" id="outlineMeta"></div>
    <h2 class="serif-title" id="outlineTitle">AI è§„åˆ’äº†ä½ çš„å­¦ä¹ è·¯å¾„</h2>
    <p class="body-sub">ç¡®è®¤å¤§çº²åç”Ÿæˆæ¯æ—¥è¯¦ç»†ä»»åŠ¡ Â· å¯éšæ—¶ä¿®æ”¹</p>
    <div id="outlinePhases"></div>
    <div class="outline-note">
      <div class="outline-note-label">AI è¯´æ˜</div>
      <div class="outline-note-text" id="outlineNote">å¯¹å¤§çº²æ»¡æ„åï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆè¯¦ç»†æ¯æ—¥ä»»åŠ¡ã€‚</div>
    </div>
    <button class="btn-primary" id="btnGenTasks" onclick="generateTasks()">ç¡®è®¤å¤§çº²ï¼Œç”Ÿæˆæ¯æ—¥ä»»åŠ¡ â†’</button>
    <button class="btn-secondary" onclick="showPage('input')">é‡æ–°ç”Ÿæˆå¤§çº²</button>
  </div>
</div>

<!-- â•â•â• PAGE: DAILY â•â•â• -->
<div class="page" id="page-daily">
  <div class="progress-wrap">
    <div class="progress-head">
      <span class="progress-goal-title" id="dailyGoalTitle">ç›®æ ‡</span>
      <span class="progress-frac" id="dailyFrac">Day 1 / 7</span>
    </div>
    <div class="progress-track"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-sub" id="progressSub"></div>
  </div>

  <div class="day-scroll" id="dayScroll"></div>

  <div class="divider">
    <div class="divider-line"></div>
    <div class="divider-text">ä»Šæ—¥ä»»åŠ¡</div>
    <div class="divider-line"></div>
  </div>

  <div class="tasks-wrap">
    <div class="tasks-day-head">
      <span class="tasks-day-title" id="dayTitle">ç¬¬ 1 å¤©</span>
      <span class="tasks-day-phase" id="dayPhase"></span>
    </div>
    <div class="tasks-day-desc" id="dayDesc"></div>
    <div id="taskList"></div>
    <div class="spacer"></div>
  </div>

  <div class="fab" id="fab">
    <div class="fab-inner">
      <div class="fab-text">
        <strong id="fabProgress">0 / 0 å®Œæˆ</strong>
        <small id="fabSub">åŠ æ²¹ï¼</small>
      </div>
      <button class="fab-action" id="fabBtn">æŸ¥çœ‹æ˜å¤© â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â• PAGE: SETTINGS â•â•â• -->
<div class="page" id="page-settings">
  <div class="page-wrap">
    <div class="mono-label">è®¾ç½®</div>
    <h1 class="serif-title">é…ç½®</h1>

    <div class="settings-section" style="margin-top:28px;">
      <div class="settings-title">API è®¾ç½®</div>
      <div class="field-group">
        <label class="field-label">ANTHROPIC API KEY</label>
        <input type="password" class="field-input" id="apiKeyInput" placeholder="sk-ant-api03-...">
        <div style="font-size:12px;color:var(--gray-400);margin-top:6px;font-family:'DM Mono',monospace;">Key ä»…å­˜å‚¨åœ¨æœ¬è®¾å¤‡ï¼Œä¸ä¼šä¸Šä¼ </div>
      </div>
      <button class="btn-primary" onclick="saveApiKey()" style="margin-top:12px;">ä¿å­˜</button>
    </div>

    <div class="settings-section">
      <div class="settings-title">æ•°æ®</div>
      <div class="settings-row">
        <div>
          <div class="settings-row-label">æ¸…é™¤æ‰€æœ‰è®¡åˆ’</div>
          <div class="settings-row-sub">æ— æ³•æ¢å¤</div>
        </div>
        <button style="background:none;border:1px solid var(--border);border-radius:6px;padding:6px 12px;font-size:12px;font-family:'DM Mono',monospace;color:var(--red);cursor:pointer;" onclick="clearAll()">æ¸…é™¤</button>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-title">å…³äº</div>
      <div class="settings-row">
        <div>
          <div class="settings-row-label">GOALflow</div>
          <div class="settings-row-sub">v1.0 Â· ç”± Claude AI é©±åŠ¨</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- BOTTOM TABS -->
<div class="bottom-tabs">
  <button class="tab-btn active" id="tab-home" onclick="showPage('home')">
    <span class="tab-icon">âŠŸ</span>
    <span class="tab-label">è®¡åˆ’</span>
  </button>
  <button class="tab-btn" id="tab-input" onclick="showPage('input')">
    <span class="tab-icon">ï¼‹</span>
    <span class="tab-label">æ–°ç›®æ ‡</span>
  </button>
  <button class="tab-btn" id="tab-daily" onclick="showPage('daily')">
    <span class="tab-icon">â—ˆ</span>
    <span class="tab-label">ä»Šæ—¥</span>
  </button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG â€” MiniMax API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_API_KEY = 'sk-api-YnQx4IddMTTtT_zESJ39PZhBiQJ7LKzFfTrGUd5eECYoLFxBZwRF8MibgE8Mhmiuf_WcZvzyVJmeYED4V96sDFxBHH4Gt9b3S6TfGHOqL3xhLktMv8pHnMA';
const MINIMAX_GROUP_ID = '2022887234998378913';
const WORKER_URL = 'https://goalflow-proxy.mokscreate.workers.dev';

// â”€â”€ STATE â”€â”€
let state = {
  plans: [],          // saved plans
  currentPlanId: null,
  currentDay: 0,      // 0-indexed
  // draft while creating
  draft: {
    goal: '',
    days: 7,
    hoursPerDay: 1,
    outline: null,    // { phases, note }
    tasks: null,      // [ { day, phase, desc, items:[{title,est,tag}] } ]
  }
};

// â”€â”€ STORAGE â”€â”€
function save() { localStorage.setItem('gf_state', JSON.stringify(state)); }
function load() {
  const raw = localStorage.getItem('gf_state');
  if (raw) { try { state = JSON.parse(raw); } catch(e){} }
}
load();

// â”€â”€ API KEY â”€â”€
function getApiKey() {
  return localStorage.getItem('gf_apikey') || DEFAULT_API_KEY;
}
function saveApiKey() {
  const k = document.getElementById('apiKeyInput').value.trim();
  if (!k) { alert('è¯·è¾“å…¥ API Key'); return; }
  localStorage.setItem('gf_apikey', k);
  alert('å·²ä¿å­˜ï¼');
}

// â”€â”€ PAGES â”€â”€
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  const tab = document.getElementById('tab-' + name);
  if (tab) tab.classList.add('active');

  if (name === 'home') renderHome();
  if (name === 'daily') renderDaily();
  if (name === 'settings') {
    const k = localStorage.getItem('gf_apikey') || '';
    document.getElementById('apiKeyInput').value = k;
  }
}

// â”€â”€ CHIPS (delegated, works after DOM updates) â”€â”€
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('chip') && e.target.closest('#timeChips')) {
    document.querySelectorAll('#timeChips .chip').forEach(x => x.classList.remove('sel'));
    e.target.classList.add('sel');
    document.getElementById('customDays').value = e.target.dataset.val;
  }
  if (e.target.classList.contains('chip') && e.target.closest('#timePerDayChips')) {
    document.querySelectorAll('#timePerDayChips .chip').forEach(x => x.classList.remove('sel'));
    e.target.classList.add('sel');
  }
  if (e.target.classList.contains('prq-chip')) {
    const block = e.target.closest('.prq-block');
    block.querySelectorAll('.prq-chip').forEach(x => x.classList.remove('sel'));
    e.target.classList.add('sel');
  }
});

// â”€â”€ STEP NAVIGATION â”€â”€
function backToStep1() {
  document.getElementById('inputStep2').style.display = 'none';
  document.getElementById('inputStep1').style.display = 'block';
}

// â”€â”€ ANALYZE GOAL (Step 1 â†’ Step 2) â”€â”€
async function analyzeGoal() {
  const goal = document.getElementById('inputGoal').value.trim();
  if (!goal) { showError('inputError', 'è¯·å…ˆå¡«å†™ä½ çš„å­¦ä¹ ç›®æ ‡'); return; }

  hideError('inputError');
  showLoading('AI æ­£åœ¨è¯„ä¼°ä½ çš„ç›®æ ‡', 'ç¨ç­‰ç‰‡åˆ»...');
  document.getElementById('btnAnalyze').disabled = true;

  try {
    const sys = 'ä½ æ˜¯å­¦ä¹ è§„åˆ’ä¸“å®¶ã€‚è¯·åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚æ ¼å¼ï¼š{"advice":"é’ˆå¯¹è¿™ä¸ªç›®æ ‡çš„æ—¶é—´è¯„ä¼°å’Œæ•´ä½“å»ºè®®ï¼ˆ2-3å¥è¯ï¼Œä¸­æ–‡ï¼‰","suggestDays":14,"suggestHours":1,"badges":[{"label":"å»ºè®®æ—¶é•¿","value":"2å‘¨"},{"label":"æ¯æ—¥æ—¶é—´","value":"1å°æ—¶"},{"label":"éš¾åº¦","value":"ä¸­ç­‰"}],"questions":[{"id":"level","label":"ä½ ç›®å‰å¯¹è¿™ä¸ªé¢†åŸŸçš„äº†è§£ç¨‹åº¦ï¼Ÿ","options":["å®Œå…¨é›¶åŸºç¡€","å¬è¯´è¿‡ä½†æ²¡å®æ“","æœ‰ä¸€äº›åŸºç¡€","æœ‰ä¸€å®šç»éªŒ"]},{"id":"goal_depth","label":"ä½ å¸Œæœ›è¾¾åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿ","options":["èƒ½çœ‹æ‡‚åŸºç¡€å†…å®¹","èƒ½ç‹¬ç«‹å®Œæˆç®€å•ä»»åŠ¡","èƒ½ç†Ÿç»ƒåº”ç”¨","è¾¾åˆ°ä¸“ä¸šæ°´å¹³"]},{"id":"style","label":"ä½ åå¥½çš„å­¦ä¹ æ–¹å¼ï¼Ÿ","options":["è¾¹å­¦è¾¹åšï¼ˆé¡¹ç›®é©±åŠ¨ï¼‰","ç³»ç»Ÿä»å¤´å­¦èµ·","å¿«é€Ÿæ‰«å®Œè¦ç‚¹","åˆ·è§†é¢‘/æ•™ç¨‹"]}]}';
    const prompt = 'å­¦ä¹ ç›®æ ‡ï¼š' + goal + '
è¯·è¯„ä¼°è¿™ä¸ªç›®æ ‡å¹¶ç”Ÿæˆå‰ç½®é—®é¢˜ã€‚';
    const raw = await callClaude(prompt, sys);
    const data = JSON.parse(raw.replace(/```json|```/g, '').trim());

    // Fill advice card
    document.getElementById('aiAdviceText').textContent = data.advice;
    document.getElementById('aiAdviceBadges').innerHTML = data.badges.map(b => `
      <div style="background:var(--gray-100);border-radius:6px;padding:6px 12px;">
        <div style="font-size:10px;font-family:'DM Mono',monospace;color:var(--gray-400);">${b.label}</div>
        <div style="font-size:14px;font-weight:500;margin-top:1px;">${b.value}</div>
      </div>
    `).join('');

    // Set suggested days
    if (data.suggestDays) {
      document.getElementById('customDays').value = data.suggestDays;
      document.querySelectorAll('#timeChips .chip').forEach(c => {
        c.classList.toggle('sel', parseInt(c.dataset.val) === data.suggestDays);
      });
    }

    // Render pre-questions (all optional)
    document.getElementById('preQuestions').innerHTML = `
      <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--gray-400);letter-spacing:0.12em;margin-bottom:14px;">è¡¥å……é—®é¢˜ï¼ˆå¯é€‰ï¼Œè·³è¿‡ä¹Ÿæ²¡å…³ç³»ï¼‰</div>
    ` + data.questions.map(q => `
      <div class="prq-block" data-qid="${q.id}">
        <div class="prq-label" style="display:flex;align-items:center;gap:8px;">
          ${q.label}
          <span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--gray-400);font-weight:300;">å¯é€‰</span>
        </div>
        <div class="prq-chips">
          <div class="prq-chip" data-val="">è·³è¿‡</div>
          ${q.options.map(opt => `<div class="prq-chip" data-val="${opt}">${opt}</div>`).join('')}
        </div>
      </div>
      <div class="prq-divider"></div>
    `).join('');

    // Store questions for later use in outline generation
    window._preQData = data.questions;

    // Show step 2
    document.getElementById('inputStep1').style.display = 'none';
    document.getElementById('inputStep2').style.display = 'block';

  } catch(e) {
    showError('inputError', 'åˆ†æå¤±è´¥ï¼š' + e.message);
  } finally {
    hideLoading();
    document.getElementById('btnAnalyze').disabled = false;
  }
}

// â”€â”€ CALL MINIMAX VIA WORKER â”€â”€
async function callClaude(prompt, systemPrompt) {
  const key = getApiKey();
  if (!key) throw new Error('è¯·å…ˆåœ¨è®¾ç½®é¡µå¡«å†™ API Key');

  const response = await fetch(WORKER_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      groupId: MINIMAX_GROUP_ID,
      apiKey: key,
      payload: {
        model: 'MiniMax-Text-01',
        max_tokens: 4096,
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: prompt }
        ]
      }
    })
  });

  if (!response.ok) {
    const err = await response.json().catch(() => ({}));
    throw new Error(err.base_resp?.status_msg || `API é”™è¯¯ ${response.status}`);
  }

  const data = await response.json();
  console.log('MiniMax response:', JSON.stringify(data));
  if (!data.choices || !data.choices[0]) {
    throw new Error('è¿”å›æ ¼å¼å¼‚å¸¸ï¼š' + JSON.stringify(data).slice(0, 200));
  }
  return data.choices[0].message.content;
}

// â”€â”€ GENERATE OUTLINE â”€â”€
async function generateOutline() {
  const goal = document.getElementById('inputGoal').value.trim();
  if (!goal) { showError('inputError2', 'ç›®æ ‡ä¸¢å¤±ï¼Œè¯·è¿”å›é‡å¡«'); return; }

  const days = parseInt(document.getElementById('customDays').value) || 7;
  const hoursChip = document.querySelector('#timePerDayChips .chip.sel');
  const hours = hoursChip ? parseFloat(hoursChip.dataset.val) : 1;

  // Collect pre-question answers (skip if user chose è·³è¿‡ or nothing)
  const answers = [];
  document.querySelectorAll('.prq-block').forEach(block => {
    const sel = block.querySelector('.prq-chip.sel');
    if (sel && sel.dataset.val) {
      const labelNode = block.querySelector('.prq-label');
      const label = labelNode.firstChild.textContent.trim();
      answers.push({ q: label, a: sel.dataset.val });
    }
  });
  const answersText = answers.length > 0
    ? answers.map(a => a.q + ' â†’ ' + a.a).join('\n')
    : 'ç”¨æˆ·æœªæä¾›é¢å¤–èƒŒæ™¯ä¿¡æ¯';

  state.draft = { goal, days, hoursPerDay: hours, outline: null, tasks: null, answers };

  hideError('inputError2');
  showLoading('AI æ­£åœ¨ç”Ÿæˆå¤§çº²', 'é€šå¸¸éœ€è¦ 10ï½20 ç§’');
  disableBtn('btnGenOutline');

  const systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹ï¼Œå¸®ç”¨æˆ·åˆ¶å®šä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’ã€‚è¯·åªè¿”å›JSONï¼Œä¸è¦è¿”å›å…¶ä»–ä»»ä½•å†…å®¹ã€‚æ ¼å¼ï¼š{"estimate":"æ—¶é—´è¯„ä¼°ä¸€å¥è¯","phases":[{"num":1,"name":"é˜¶æ®µå","days":"Day 1-3","dayStart":1,"dayEnd":3,"desc":"æè¿°","topics":["ä¸»é¢˜1","ä¸»é¢˜2"]}],"note":"å»ºè®®ä¸€å¥è¯"}';

  const prompt = `å­¦ä¹ ç›®æ ‡ï¼š${goal}
è®¡åˆ’å¤©æ•°ï¼š${days} å¤©
æ¯å¤©å­¦ä¹ æ—¶é—´ï¼š${hours} å°æ—¶
ç”¨æˆ·èƒŒæ™¯ä¿¡æ¯ï¼š
${answersText}

è¯·æ ¹æ®ç”¨æˆ·çš„èƒŒæ™¯ä¿¡æ¯ç”Ÿæˆä¸ªæ€§åŒ–çš„å­¦ä¹ é˜¶æ®µå¤§çº²ï¼Œé˜¶æ®µæ•°é‡æ ¹æ®å¤©æ•°åˆç†åˆ†é…ï¼ˆé€šå¸¸2-4ä¸ªé˜¶æ®µï¼‰ã€‚`;

  try {
    const raw = await callClaude(prompt, systemPrompt);
    const cleaned = raw.replace(/```json|```/g, '').trim();
    const outline = JSON.parse(cleaned);
    state.draft.outline = outline;
    renderOutline();
    showPage('outline');
  } catch(e) {
    showError('inputError2', 'ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
  } finally {
    hideLoading();
    enableBtn('btnGenOutline', 'ç”Ÿæˆå­¦ä¹ å¤§çº² â†’');
  }
}

function renderOutline() {
  const { goal, days, hoursPerDay, outline } = state.draft;

  document.getElementById('outlineMeta').innerHTML = `
    <span class="meta-tag">${goal.slice(0,15)}${goal.length>15?'â€¦':''}</span>
    <span class="meta-tag">${days} å¤©</span>
    <span class="meta-tag">æ¯å¤© ${hoursPerDay}h</span>
  `;

  document.getElementById('outlineTitle').textContent = `AI è§„åˆ’äº† ${outline.phases.length} ä¸ªå­¦ä¹ é˜¶æ®µ`;
  document.getElementById('outlineNote').textContent = outline.note;

  // AI estimate tip on input page
  document.getElementById('aiEstimateText').innerHTML = `<strong>AI é¢„ä¼°ï¼š</strong>${outline.estimate}`;
  document.getElementById('aiEstimateTip').style.display = 'flex';

  document.getElementById('outlinePhases').innerHTML = outline.phases.map((p, i) => `
    <div class="phase-card" onclick="openPhaseSheet(${i})">
      <div class="phase-top">
        <span class="phase-num">PHASE ${String(i+1).padStart(2,'0')}</span>
        <span class="phase-days-badge">${p.days}</span>
      </div>
      <div class="phase-name">${p.name}</div>
      <div class="phase-desc">${p.desc}</div>
      <div class="phase-topics">
        ${p.topics.map(t => `<span class="topic-tag">${t}</span>`).join('')}
      </div>
      <div class="phase-card-arrow">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ä¸ AI è®¨è®º â†’</div>
    </div>
  `).join('');
}

// â”€â”€ GENERATE TASKS â”€â”€
async function generateTasks() {
  const { goal, days, hoursPerDay, outline } = state.draft;

  showLoading('AI æ­£åœ¨ç”Ÿæˆæ¯æ—¥ä»»åŠ¡', 'å†…å®¹è¾ƒå¤šï¼Œéœ€è¦ 20ï½40 ç§’');
  disableBtn('btnGenTasks');

  const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹ï¼Œå¸®ç”¨æˆ·æ‹†è§£æ¯æ—¥å­¦ä¹ ä»»åŠ¡ã€‚è¯·åªè¿”å›JSONï¼Œä¸è¦è¿”å›å…¶ä»–ä»»ä½•å†…å®¹ã€‚æ ¼å¼ï¼š{"days":[{"day":1,"phase":"é˜¶æ®µå","desc":"ä»Šæ—¥ä¸»é¢˜","items":[{"title":"ä»»åŠ¡å","est":"çº¦15åˆ†é’Ÿ","tag":"å­¦ä¹ "}]}]}`;

  const outlineText = outline.phases.map(p =>
    `${p.name}ï¼ˆ${p.days}ï¼‰ï¼š${p.desc}ã€‚ä¸»é¢˜ï¼š${p.topics.join('ã€')}`
  ).join('\n');

  const prompt = `ç›®æ ‡ï¼š${goal}
è®¡åˆ’ï¼š${days} å¤©ï¼Œæ¯å¤© ${hoursPerDay} å°æ—¶
å¤§çº²ï¼š
${outlineText}

è¯·ä¸ºæ¯ä¸€å¤©ï¼ˆå…± ${days} å¤©ï¼‰ç”Ÿæˆ 3-5 ä¸ªå…·ä½“å¯æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡æœ‰æ ‡é¢˜ã€é¢„è®¡æ—¶é—´å’Œç±»å‹æ ‡ç­¾ã€‚`;

  try {
    const raw = await callClaude(prompt, systemPrompt);
    const cleaned = raw.replace(/```json|```/g, '').trim();
    const result = JSON.parse(cleaned);
    state.draft.tasks = result.days;

    // save as plan
    const planId = Date.now().toString();
    const plan = {
      id: planId,
      goal,
      days,
      hoursPerDay,
      outline,
      tasks: result.days,
      checks: {}, // { "day-taskIdx": true }
      createdAt: new Date().toLocaleDateString('zh-CN'),
    };
    state.plans.push(plan);
    state.currentPlanId = planId;
    state.currentDay = 0;
    save();

    showPage('daily');
  } catch(e) {
    document.getElementById('page-outline').querySelector('.error-box') && null;
    alert('ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
    enableBtn('btnGenTasks', 'ç¡®è®¤å¤§çº²ï¼Œç”Ÿæˆæ¯æ—¥ä»»åŠ¡ â†’');
  } finally {
    hideLoading();
  }
}

// â”€â”€ RENDER HOME â”€â”€
function renderHome() {
  const el = document.getElementById('planList');
  if (state.plans.length === 0) {
    el.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">âœ¦</div>
        <div class="empty-title">è¿˜æ²¡æœ‰è®¡åˆ’</div>
        <div class="empty-sub">åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ª AI å­¦ä¹ è®¡åˆ’</div>
        <button class="btn-start" onclick="showPage('input')">å¼€å§‹è§„åˆ’ â†’</button>
      </div>
    `;
    return;
  }

  el.innerHTML = state.plans.slice().reverse().map(plan => {
    const totalTasks = plan.tasks.reduce((s, d) => s + d.items.length, 0);
    const doneTasks = Object.keys(plan.checks).length;
    const pct = totalTasks ? Math.round(doneTasks / totalTasks * 100) : 0;
    return `
      <div class="plan-card" onclick="openPlan('${plan.id}')">
        <div class="plan-card-head">
          <div class="plan-card-title">${plan.goal}</div>
          <div class="plan-card-date">${plan.createdAt}</div>
        </div>
        <div class="plan-progress-mini">
          <div class="plan-progress-mini-fill" style="width:${pct}%"></div>
        </div>
        <div class="plan-progress-label">${doneTasks} / ${totalTasks} ä»»åŠ¡å®Œæˆ Â· ${plan.days}å¤©è®¡åˆ’</div>
        <button class="plan-card-del" onclick="event.stopPropagation();deletePlan('${plan.id}')">åˆ é™¤</button>
      </div>
    `;
  }).join('');
}

function openPlan(id) {
  state.currentPlanId = id;
  state.currentDay = 0;
  // find today: first day with incomplete tasks
  const plan = getPlan();
  if (plan) {
    for (let i = 0; i < plan.tasks.length; i++) {
      const dayDone = plan.tasks[i].items.every((_, ti) => plan.checks[`${i}-${ti}`]);
      if (!dayDone) { state.currentDay = i; break; }
      if (i === plan.tasks.length - 1) state.currentDay = i;
    }
  }
  save();
  showPage('daily');
}

function deletePlan(id) {
  if (!confirm('ç¡®è®¤åˆ é™¤è¿™ä¸ªè®¡åˆ’ï¼Ÿ')) return;
  state.plans = state.plans.filter(p => p.id !== id);
  if (state.currentPlanId === id) state.currentPlanId = null;
  save();
  renderHome();
}

function clearAll() {
  if (!confirm('ç¡®è®¤æ¸…é™¤æ‰€æœ‰è®¡åˆ’ï¼Ÿ')) return;
  state.plans = [];
  state.currentPlanId = null;
  save();
  renderHome();
}

// â”€â”€ RENDER DAILY â”€â”€
function getPlan() { return state.plans.find(p => p.id === state.currentPlanId); }

function renderDaily() {
  const plan = getPlan();
  if (!plan) {
    document.getElementById('page-daily').innerHTML = `<div class="page-wrap"><div class="empty-state"><div class="empty-icon">â—ˆ</div><div class="empty-title">æ²¡æœ‰æ´»è·ƒè®¡åˆ’</div><div class="empty-sub">å»åˆ›å»ºä¸€ä¸ªå§</div><button class="btn-start" onclick="showPage('input')">å¼€å§‹è§„åˆ’ â†’</button></div></div>`;
    return;
  }

  const { tasks, checks, goal, days } = plan;
  const totalTasks = tasks.reduce((s, d) => s + d.items.length, 0);
  const doneTasks = Object.keys(checks).length;
  const pct = totalTasks ? Math.round(doneTasks / totalTasks * 100) : 0;

  document.getElementById('dailyGoalTitle').textContent = goal.slice(0, 12) + (goal.length > 12 ? 'â€¦' : '');
  document.getElementById('dailyFrac').textContent = `Day ${state.currentDay + 1} / ${days}`;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressSub').textContent = `æ•´ä½“å®Œæˆ ${pct}%`;

  // day scroll
  document.getElementById('dayScroll').innerHTML = tasks.map((_, i) => {
    const dayDone = tasks[i].items.every((__, ti) => checks[`${i}-${ti}`]);
    const isCur = i === state.currentDay;
    return `<div class="day-btn ${isCur ? 'cur' : ''} ${dayDone ? 'done' : ''}" onclick="selectDay(${i})">
      <span class="day-num-text">${i + 1}</span>
      <div class="day-dot"></div>
    </div>`;
  }).join('');

  renderDayTasks();
}

function selectDay(i) {
  state.currentDay = i;
  save();
  const plan = getPlan();
  document.querySelectorAll('.day-btn').forEach((b, idx) => {
    b.classList.toggle('cur', idx === i);
  });
  renderDayTasks();
}

function renderDayTasks() {
  const plan = getPlan();
  if (!plan) return;
  const dayData = plan.tasks[state.currentDay];
  if (!dayData) return;

  document.getElementById('dayTitle').textContent = `ç¬¬ ${state.currentDay + 1} å¤©`;
  document.getElementById('dayPhase').textContent = dayData.phase || '';
  document.getElementById('dayDesc').textContent = dayData.desc || '';

  const checks = plan.checks;
  const items = dayData.items;
  const doneCnt = items.filter((_, ti) => checks[`${state.currentDay}-${ti}`]).length;

  document.getElementById('taskList').innerHTML = items.map((item, ti) => {
    const key = `${state.currentDay}-${ti}`;
    const done = !!checks[key];
    return `<div class="task-item ${done ? 'done' : ''}">
      <div class="task-check" onclick="toggleTask(${ti})"><span class="check-mark">âœ“</span></div>
      <div class="task-body" onclick="openTaskSheet(${ti})">
        <div class="task-title">${item.title}</div>
        <div class="task-est">â± ${item.est}</div>
        <span class="task-tag">${item.tag}</span>
        <div style="font-size:11px;color:var(--gray-400);font-family:'DM Mono',monospace;margin-top:4px;">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’</div>
      </div>
    </div>`;
  }).join('');

  // fab
  document.getElementById('fabProgress').textContent = `${doneCnt} / ${items.length} å®Œæˆ`;
  const allDone = doneCnt === items.length;
  const isLast = state.currentDay === plan.tasks.length - 1;
  document.getElementById('fabSub').textContent = allDone
    ? (isLast ? 'ğŸ‰ å…¨éƒ¨å®Œæˆï¼' : 'ä»Šæ—¥å…¨éƒ¨å®Œæˆï¼Œç»§ç»­åŠ æ²¹ï¼')
    : `è¿˜æœ‰ ${items.length - doneCnt} ä¸ªä»»åŠ¡`;
  const fabBtn = document.getElementById('fabBtn');
  if (allDone && !isLast) {
    fabBtn.textContent = 'æŸ¥çœ‹æ˜å¤© â†’';
    fabBtn.onclick = () => selectDay(state.currentDay + 1);
  } else {
    fabBtn.textContent = 'è®¡åˆ’è¯¦æƒ…';
    fabBtn.onclick = () => showPage('home');
  }
}

function toggleTask(ti) {
  const plan = getPlan();
  if (!plan) return;
  const key = `${state.currentDay}-${ti}`;
  if (plan.checks[key]) delete plan.checks[key];
  else plan.checks[key] = true;
  save();
  renderDayTasks();
  // update day scroll dots
  const dayData = plan.tasks[state.currentDay];
  const allDone = dayData.items.every((_, i) => plan.checks[`${state.currentDay}-${i}`]);
  const dayBtns = document.querySelectorAll('.day-btn');
  if (dayBtns[state.currentDay]) dayBtns[state.currentDay].classList.toggle('done', allDone);
  // update progress
  const totalTasks = plan.tasks.reduce((s, d) => s + d.items.length, 0);
  const doneTasks = Object.keys(plan.checks).length;
  const pct = totalTasks ? Math.round(doneTasks / totalTasks * 100) : 0;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressSub').textContent = `æ•´ä½“å®Œæˆ ${pct}%`;
}


// â”€â”€ PHASE SHEET â”€â”€
let currentPhaseIdx = null;
let phaseDetailCache = {};
let phaseChatHistory = {};

async function openPhaseSheet(idx) {
  const { outline, goal, days, hoursPerDay } = state.draft;
  const phase = outline.phases[idx];
  currentPhaseIdx = idx;

  document.getElementById('sheetPhaseTitle').textContent = phase.name;
  document.getElementById('sheetPhaseDays').textContent = `${phase.days}ï¼Œå…± ${phase.dayEnd - phase.dayStart + 1} å¤©`;
  document.getElementById('sheetPhaseReason').innerHTML = '<div class="sheet-loading"><div class="sheet-loading-spin"></div>AI åˆ†æä¸­...</div>';
  document.getElementById('sheetPhaseDetail').innerHTML = '';
  document.getElementById('phaseChatMessages').innerHTML = '';
  document.getElementById('phaseChatInput').value = '';
  document.getElementById('phaseSheet').classList.remove('hidden');

  if (phaseDetailCache[idx]) {
    renderPhaseDetail(phaseDetailCache[idx]);
    return;
  }

  try {
    const sys = 'ä½ æ˜¯å­¦ä¹ é¡¾é—®ã€‚è¯·åªè¿”å›JSONï¼Œæ ¼å¼ï¼š{"reason":"é€‰æ‹©è¿™ä¸ªé˜¶æ®µçš„ç†ç”±2-3å¥è¯","detail":"è¯¦ç»†å†…å®¹ä»‹ç»3-4å¥è¯ï¼ŒåŒ…æ‹¬å…·ä½“ä¼šå­¦åˆ°ä»€ä¹ˆ"}';
    const prompt = `å­¦ä¹ ç›®æ ‡ï¼š${goal}ï¼ˆ${days}å¤©ï¼Œæ¯å¤©${hoursPerDay}å°æ—¶ï¼‰
é˜¶æ®µï¼š${phase.name}ï¼ˆ${phase.days}ï¼‰
æè¿°ï¼š${phase.desc}
ä¸»é¢˜ï¼š${phase.topics.join('ã€')}

è¯·è§£é‡Šä¸ºä»€ä¹ˆè®¾ç½®è¿™ä¸ªé˜¶æ®µï¼Œä»¥åŠè¯¦ç»†ä¼šå­¦åˆ°ä»€ä¹ˆã€‚`;
    const raw = await callClaude(prompt, sys);
    const data = JSON.parse(raw.replace(/```json|```/g, '').trim());
    phaseDetailCache[idx] = data;
    renderPhaseDetail(data);
  } catch(e) {
    document.getElementById('sheetPhaseReason').textContent = 'åŠ è½½å¤±è´¥ï¼š' + e.message;
  }
}

function renderPhaseDetail(data) {
  document.getElementById('sheetPhaseReason').innerHTML = data.reason;
  document.getElementById('sheetPhaseDetail').innerHTML = data.detail;
}

async function sendPhaseChat() {
  const input = document.getElementById('phaseChatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';

  const { outline, goal, days, hoursPerDay } = state.draft;
  const phase = outline.phases[currentPhaseIdx];

  const messagesEl = document.getElementById('phaseChatMessages');
  messagesEl.innerHTML += `<div class="chat-msg user">${msg}</div>`;

  const sendBtn = document.getElementById('phaseChatSend');
  sendBtn.disabled = true;
  sendBtn.textContent = '...';

  const loadingEl = document.createElement('div');
  loadingEl.className = 'chat-msg ai';
  loadingEl.innerHTML = '<div class="sheet-loading-spin" style="width:16px;height:16px;margin:2px 0"></div>';
  messagesEl.appendChild(loadingEl);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  try {
    if (!phaseChatHistory[currentPhaseIdx]) phaseChatHistory[currentPhaseIdx] = [];
    phaseChatHistory[currentPhaseIdx].push({ role: 'user', content: msg });

    const sys = `ä½ æ˜¯å­¦ä¹ è§„åˆ’åŠ©æ‰‹ã€‚ç”¨æˆ·æ­£åœ¨è®¨è®ºå­¦ä¹ è®¡åˆ’ä¸­çš„ä¸€ä¸ªé˜¶æ®µï¼Œå¯ä»¥æå‡ºä¿®æ”¹æ„è§ã€‚
å½“å‰é˜¶æ®µï¼š${phase.name}ï¼ˆ${phase.days}ï¼‰
ç›®æ ‡ï¼š${goal}ï¼ˆ${days}å¤©ï¼Œæ¯å¤©${hoursPerDay}å°æ—¶ï¼‰
å¦‚æœç”¨æˆ·è¦æ±‚ä¿®æ”¹é˜¶æ®µï¼Œè¯·è¿”å›JSONï¼š{"action":"update","name":"æ–°é˜¶æ®µå","days":"${phase.days}","desc":"æ–°æè¿°","topics":["ä¸»é¢˜1","ä¸»é¢˜2"]}
å¦‚æœåªæ˜¯å›ç­”é—®é¢˜ï¼Œè¿”å›JSONï¼š{"action":"reply","message":"å›å¤å†…å®¹"}`;

    const historyMsgs = phaseChatHistory[currentPhaseIdx].map(m => ({ role: m.role, content: m.content }));
    const raw = await callClaude(historyMsgs.map(m => m.content).join('\n'), sys);
    const data = JSON.parse(raw.replace(/```json|```/g, '').trim());

    loadingEl.remove();

    if (data.action === 'update') {
      // Apply the update to outline
      state.draft.outline.phases[currentPhaseIdx] = {
        ...phase,
        name: data.name,
        desc: data.desc,
        topics: data.topics
      };
      phaseDetailCache[currentPhaseIdx] = null;
      renderOutline();
      messagesEl.innerHTML += `<div class="chat-msg ai">âœ“ å·²æ›´æ–°é˜¶æ®µä¸º"${data.name}"ï¼Œå¤§çº²å·²åˆ·æ–°ã€‚</div>`;
      document.getElementById('sheetPhaseTitle').textContent = data.name;
      document.getElementById('sheetPhaseReason').textContent = 'é˜¶æ®µå·²æ›´æ–°ï¼Œå…³é—­é‡æ–°æ‰“å¼€æŸ¥çœ‹æ–°è¯¦æƒ…ã€‚';
      document.getElementById('sheetPhaseDetail').textContent = data.desc;
    } else {
      phaseChatHistory[currentPhaseIdx].push({ role: 'assistant', content: data.message });
      messagesEl.innerHTML += `<div class="chat-msg ai">${data.message}</div>`;
    }
  } catch(e) {
    loadingEl.remove();
    messagesEl.innerHTML += `<div class="chat-msg ai">å‡ºé”™äº†ï¼š${e.message}</div>`;
  } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = 'å‘é€';
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
}

// â”€â”€ TASK SHEET â”€â”€
let taskDetailCache = {};

async function openTaskSheet(ti) {
  const plan = getPlan();
  if (!plan) return;
  const dayData = plan.tasks[state.currentDay];
  const item = dayData.items[ti];
  const cacheKey = `${state.currentPlanId}-${state.currentDay}-${ti}`;

  document.getElementById('sheetTaskTitle').textContent = item.title;
  document.getElementById('sheetTaskEst').textContent = item.est + ' Â· ' + item.tag;
  document.getElementById('sheetTaskDetail').innerHTML = '<div class="sheet-loading"><div class="sheet-loading-spin"></div>AI ç”Ÿæˆä¸­...</div>';
  document.getElementById('sheetTaskResourceList').innerHTML = '<div class="sheet-loading"><div class="sheet-loading-spin"></div>åŠ è½½ä¸­...</div>';
  document.getElementById('taskSheet').classList.remove('hidden');

  if (taskDetailCache[cacheKey]) {
    renderTaskDetail(taskDetailCache[cacheKey]);
    return;
  }

  try {
    const sys = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¸­æ–‡å­¦ä¹ æ•™ç»ƒã€‚è¯·åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚
æ ¼å¼ï¼š{
  "summary": "ä¸€å¥è¯æ€»ç»“è¿™ä¸ªä»»åŠ¡çš„æ ¸å¿ƒç›®æ ‡",
  "keypoints": ["çŸ¥è¯†ç‚¹1ï¼šè¯¦ç»†è§£é‡Š", "çŸ¥è¯†ç‚¹2ï¼šè¯¦ç»†è§£é‡Š", "çŸ¥è¯†ç‚¹3ï¼šè¯¦ç»†è§£é‡Š"],
  "example": "ä¸€ä¸ªå…·ä½“çš„ä»£ç ç¤ºä¾‹æˆ–æ“ä½œç¤ºä¾‹ï¼ˆå¦‚æœé€‚ç”¨ï¼‰",
  "tips": "ä¸€æ¡å®ç”¨çš„å­¦ä¹ å»ºè®®æˆ–å¸¸è§è¯¯åŒºæé†’"
}
å…¨éƒ¨ç”¨ä¸­æ–‡ï¼Œå†…å®¹è¦å…·ä½“å®ç”¨ï¼Œåƒè€å¸ˆåœ¨ç»™å­¦ç”Ÿè®²è§£ä¸€æ ·ã€‚`;
    const prompt = `å­¦ä¹ ç›®æ ‡ï¼š${plan.goal}
ä»Šæ—¥ä¸»é¢˜ï¼š${dayData.desc}
ä»»åŠ¡ï¼š${item.title}ï¼ˆ${item.est}ï¼‰
ç±»å‹ï¼š${item.tag}
è¯·ç”Ÿæˆè¿™ä¸ªä»»åŠ¡çš„è¯¦ç»†ä¸­æ–‡å­¦ä¹ å†…å®¹ï¼ŒåŒ…æ‹¬æ ¸å¿ƒçŸ¥è¯†ç‚¹å’Œç¤ºä¾‹ã€‚`;
    const raw = await callClaude(prompt, sys);
    const data = JSON.parse(raw.replace(/```json|```/g, '').trim());
    taskDetailCache[cacheKey] = data;
    renderTaskDetail(data);
  } catch(e) {
    document.getElementById('sheetTaskDetail').textContent = 'åŠ è½½å¤±è´¥ï¼š' + e.message;
    document.getElementById('sheetTaskResourceList').innerHTML = '';
  }
}

function renderTaskDetail(data) {
  document.getElementById('sheetTaskDetail').innerHTML = `
    <div style="margin-bottom:14px;">
      <div style="font-size:13px;color:var(--green);background:var(--green-light);border-radius:6px;padding:10px 12px;line-height:1.6;">${data.summary}</div>
    </div>
    <div style="margin-bottom:16px;">
      ${data.keypoints.map((kp, i) => `
        <div style="padding:10px 0;border-bottom:1px solid var(--border);">
          <div style="font-size:11px;font-family:'DM Mono',monospace;color:var(--gray-400);margin-bottom:4px;">POINT ${String(i+1).padStart(2,'0')}</div>
          <div style="font-size:14px;line-height:1.7;color:var(--black);"><strong>${kp.split('ï¼š')[0]}</strong>${kp.includes('ï¼š') ? 'ï¼š' + kp.split('ï¼š').slice(1).join('ï¼š') : ''}</div>
        </div>
      `).join('')}
    </div>
    ${data.example ? `
      <div style="margin-bottom:16px;">
        <div style="font-size:11px;font-family:'DM Mono',monospace;color:var(--gray-400);margin-bottom:6px;">ç¤ºä¾‹</div>
        <div style="background:#1e1e1e;color:#d4d4d4;border-radius:8px;padding:14px;font-family:'DM Mono',monospace;font-size:13px;line-height:1.7;white-space:pre-wrap;overflow-x:auto;">${data.example}</div>
      </div>
    ` : ''}
    <div style="background:var(--gray-100);border-radius:6px;padding:10px 12px;">
      <div style="font-size:11px;font-family:'DM Mono',monospace;color:var(--gray-400);margin-bottom:4px;">ğŸ’¡ å­¦ä¹ å»ºè®®</div>
      <div style="font-size:13px;color:var(--gray-600);line-height:1.6;">${data.tips}</div>
    </div>
  `;
  document.getElementById('sheetTaskResources').style.display = 'none';
}

function closeSheet(id) {
  document.getElementById(id).classList.add('hidden');
}

// close sheet on overlay click
document.getElementById('phaseSheet').addEventListener('click', function(e) {
  if (e.target === this) closeSheet('phaseSheet');
});
document.getElementById('taskSheet').addEventListener('click', function(e) {
  if (e.target === this) closeSheet('taskSheet');
});

// enter key in chat
document.getElementById('phaseChatInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendPhaseChat(); }
});


// â”€â”€ LOADING â”€â”€
function showLoading(msg, sub) {
  document.getElementById('loadingMsg').textContent = msg;
  document.getElementById('loadingSub').textContent = sub;
  document.getElementById('loadingOverlay').classList.remove('hidden');
}
function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

// â”€â”€ BUTTONS â”€â”€
function disableBtn(id) { const b = document.getElementById(id); b.disabled = true; b.textContent = 'ç”Ÿæˆä¸­'; b.classList.add('loading-dots'); }
function enableBtn(id, label) { const b = document.getElementById(id); b.disabled = false; b.textContent = label; b.classList.remove('loading-dots'); }

// â”€â”€ ERRORS â”€â”€
function showError(id, msg) { const el = document.getElementById(id); el.textContent = msg; el.style.display = 'block'; }
function hideError(id) { document.getElementById(id).style.display = 'none'; }

// â”€â”€ INIT â”€â”€
showPage('home');
if (state.plans.length === 0) showPage('input');
</script>

<!-- PHASE DETAIL SHEET -->
<div class="sheet-overlay hidden" id="phaseSheet">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <div class="sheet-title" id="sheetPhaseTitle">é˜¶æ®µè¯¦æƒ…</div>
      <button class="sheet-close" onclick="closeSheet('phaseSheet')">âœ•</button>
    </div>
    <div class="sheet-body">
      <div class="sheet-section">
        <div class="sheet-section-label">æ—¶é—´èŒƒå›´</div>
        <div class="sheet-section-text" id="sheetPhaseDays"></div>
      </div>
      <div class="sheet-section">
        <div class="sheet-section-label">AI é€‰æ‹©è¿™ä¸ªé˜¶æ®µçš„ç†ç”±</div>
        <div class="sheet-section-text" id="sheetPhaseReason">
          <div class="sheet-loading"><div class="sheet-loading-spin"></div>åŠ è½½ä¸­...</div>
        </div>
      </div>
      <div class="sheet-section">
        <div class="sheet-section-label">è¯¦ç»†å†…å®¹ä»‹ç»</div>
        <div class="sheet-section-text" id="sheetPhaseDetail"></div>
      </div>
      <div class="sheet-chat">
        <div class="sheet-chat-label">å’Œ AI è®¨è®ºè¿™ä¸ªé˜¶æ®µ</div>
        <div class="chat-messages" id="phaseChatMessages"></div>
        <div class="chat-input-row">
          <input class="chat-input" id="phaseChatInput" placeholder="ä¾‹å¦‚ï¼šè¿™éƒ¨åˆ†æˆ‘å·²ç»ä¼šäº†ï¼Œæ¢æˆåˆ«çš„â€¦" />
          <button class="chat-send" id="phaseChatSend" onclick="sendPhaseChat()">å‘é€</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TASK DETAIL SHEET -->
<div class="sheet-overlay hidden" id="taskSheet">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <div class="sheet-title" id="sheetTaskTitle">ä»»åŠ¡è¯¦æƒ…</div>
      <button class="sheet-close" onclick="closeSheet('taskSheet')">âœ•</button>
    </div>
    <div class="sheet-body">
      <div class="sheet-section">
        <div class="sheet-section-label">é¢„è®¡æ—¶é—´</div>
        <div class="sheet-section-text" id="sheetTaskEst"></div>
      </div>
      <div class="sheet-section">
        <div class="sheet-section-label">å­¦ä¹ è¯´æ˜</div>
        <div class="sheet-section-text" id="sheetTaskDetail">
          <div class="sheet-loading"><div class="sheet-loading-spin"></div>AI ç”Ÿæˆä¸­...</div>
        </div>
      </div>
      <div class="sheet-section" id="sheetTaskResources">
        <div class="sheet-section-label">æ¨èå­¦ä¹ èµ„æº</div>
        <div id="sheetTaskResourceList">
          <div class="sheet-loading"><div class="sheet-loading-spin"></div>åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
