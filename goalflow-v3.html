<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>GOALflow Mobile</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root { --black: #0f0f0f; --white: #f5f4f0; --gray-100: #eeede9; --gray-200: #dddcd8; --gray-400: #999890; --gray-600: #666560; --border: #e0dfd9; --green: #3d6b4f; --green-light: #e8f0eb; --green-border: #c5dac9; --red: #c0392b; --red-light: #fdf0ee; }
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { background: var(--white); color: var(--black); font-family: 'Noto Sans SC', sans-serif; font-weight: 300; line-height: 1.6; min-height: 100vh; overflow-x: hidden; }
nav { display: flex; align-items: center; justify-content: space-between; padding: 18px 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--white); z-index: 100; }
.logo { font-family: 'DM Serif Display', serif; font-size: 18px; letter-spacing: 0.05em; }
.logo em { font-style: italic; color: var(--gray-600); }
.nav-right { display: flex; align-items: center; gap: 12px; }
.btn-settings { background: none; border: 1px solid var(--border); border-radius: 6px; padding: 4px 10px; font-size: 11px; font-family: 'DM Mono', monospace; color: var(--gray-600); cursor: pointer; }
.page { display: none; animation: fadeUp 0.25s ease; }
.page.active { display: block; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.bottom-tabs { position: fixed; bottom: 0; left: 0; right: 0; height: 58px; background: var(--white); border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-around; z-index: 200; }
.tab-btn { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 6px 20px; cursor: pointer; border: none; background: none; color: var(--gray-400); transition: color 0.15s; }
.tab-btn.active { color: var(--black); }
.tab-icon { font-size: 17px; }
.tab-label { font-size: 10px; font-family: 'DM Mono', monospace; letter-spacing: 0.04em; }
.page-wrap { padding: 36px 20px 100px; max-width: 520px; margin: 0 auto; }
.mono-label { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.14em; color: var(--gray-400); text-transform: uppercase; margin-bottom: 28px; }
.serif-title { font-family: 'DM Serif Display', serif; font-size: 30px; line-height: 1.25; margin-bottom: 6px; }
.serif-title em { font-style: italic; color: var(--gray-600); }
.body-sub { font-size: 13px; color: var(--gray-600); margin-bottom: 36px; }
.field-group { margin-bottom: 22px; }
.field-label { font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.1em; color: var(--gray-600); margin-bottom: 8px; display: block; }
.field-input { width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 13px 15px; font-family: 'Noto Sans SC', sans-serif; font-size: 15px; font-weight: 300; color: var(--black); background: var(--white); outline: none; transition: border-color 0.2s; -webkit-appearance: none; }
.field-input:focus { border-color: var(--black); }
.field-input::placeholder { color: var(--gray-400); }
textarea.field-input { resize: none; height: 96px; }
.chips { display: flex; gap: 7px; flex-wrap: wrap; }
.chip { padding: 7px 14px; border: 1px solid var(--border); border-radius: 20px; font-size: 12px; font-family: 'DM Mono', monospace; cursor: pointer; transition: all 0.15s; background: var(--white); color: var(--gray-600); }
.chip.sel { background: var(--black); color: var(--white); border-color: var(--black); }
.ai-tip { background: var(--green-light); border: 1px solid var(--green-border); border-radius: 8px; padding: 12px 14px; margin-top: 10px; display: flex; gap: 10px; align-items: flex-start; }
.ai-tip-icon { font-size: 13px; flex-shrink: 0; margin-top: 2px; color: var(--green); }
.ai-tip-text { font-size: 13px; color: var(--green); line-height: 1.55; }
.ai-tip-text strong { font-weight: 500; }
.btn-primary { width: 100%; padding: 15px; background: var(--black); color: var(--white); border: none; border-radius: 10px; font-size: 15px; font-family: 'Noto Sans SC', sans-serif; font-weight: 400; cursor: pointer; letter-spacing: 0.03em; transition: opacity 0.15s; margin-top: 28px; position: relative; }
.btn-primary:active { opacity: 0.8; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-secondary { width: 100%; padding: 14px; background: transparent; color: var(--black); border: 1px solid var(--border); border-radius: 10px; font-size: 14px; font-family: 'Noto Sans SC', sans-serif; cursor: pointer; margin-top: 10px; }
.loading-dots::after { content: ''; animation: dots 1.2s infinite; }
@keyframes dots { 0%,20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%,100% { content: '...'; } }
.error-box { background: var(--red-light); border: 1px solid #f0c8c4; border-radius: 8px; padding: 12px 14px; margin-top: 12px; font-size: 13px; color: var(--red); line-height: 1.55; }
.time-custom { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
.time-custom input { width: 60px; border: 1px solid var(--border); border-radius: 6px; padding: 7px 10px; font-family: 'DM Mono', monospace; font-size: 13px; text-align: center; outline: none; background: var(--white); color: var(--black); }
.time-custom span { font-size: 13px; color: var(--gray-600); }
.meta-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
.meta-tag { font-family: 'DM Mono', monospace; font-size: 11px; padding: 3px 9px; background: var(--gray-100); border-radius: 4px; color: var(--gray-600); }
.phase-card { border: 1px solid var(--border); border-radius: 12px; padding: 18px; margin-bottom: 10px; background: var(--white); }
.phase-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.phase-num { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--gray-400); letter-spacing: 0.1em; }
.phase-days-badge { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--gray-600); background: var(--gray-100); padding: 2px 8px; border-radius: 4px; }
.phase-name { font-size: 15px; font-weight: 500; margin-bottom: 5px; }
.phase-desc { font-size: 13px; color: var(--gray-600); line-height: 1.6; }
.phase-topics { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
.topic-tag { font-size: 11px; padding: 2px 8px; border: 1px solid var(--border); border-radius: 4px; color: var(--gray-600); font-family: 'DM Mono', monospace; }
.outline-note { margin-top: 18px; padding: 14px; border: 1px dashed var(--border); border-radius: 10px; }
.outline-note-label { font-size: 11px; color: var(--gray-400); font-family: 'DM Mono', monospace; margin-bottom: 5px; }
.outline-note-text { font-size: 13px; color: var(--gray-600); line-height: 1.6; }
.progress-wrap { padding: 20px 20px 0; }
.progress-head { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
.progress-goal-title { font-family: 'DM Serif Display', serif; font-size: 20px; }
.progress-frac { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--gray-600); }
.progress-track { height: 3px; background: var(--gray-200); border-radius: 2px; overflow: hidden; margin-bottom: 4px; }
.progress-fill { height: 100%; background: var(--black); border-radius: 2px; transition: width 0.5s ease; }
.progress-sub { font-size: 11px; color: var(--gray-400); font-family: 'DM Mono', monospace; }
.day-scroll { display: flex; gap: 7px; padding: 18px 20px 0; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
.day-scroll::-webkit-scrollbar { display: none; }
.day-btn { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; width: 50px; padding: 10px 0; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; background: var(--white); transition: all 0.15s; gap: 3px; }
.day-btn.active { background: var(--black); color: var(--white); border-color: var(--black); }
.day-btn.done .day-check { color: var(--green); }
.day-btn.done .day-check::before { content: 'âœ“'; }
.day-btn.done .day-check { font-size: 14px; }
.day-num { font-family: 'DM Mono', monospace; font-size: 10px; }
.day-date { font-size: 10px; color: var(--gray-400); }
.day-btn.active .day-date { color: var(--gray-400); }
.task-list { padding: 20px; }
.task-item { display: flex; gap: 12px; padding: 14px 0; border-bottom: 1px solid var(--border); }
.task-check { width: 22px; height: 22px; border: 2px solid var(--gray-200); border-radius: 50%; flex-shrink: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; color: transparent; transition: all 0.15s; }
.task-item.done .task-check { background: var(--green); border-color: var(--green); color: white; }
.task-item.done .task-text { text-decoration: line-through; color: var(--gray-400); }
.task-text { font-size: 14px; line-height: 1.5; flex: 1; }
.settings-title { font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.1em; color: var(--gray-600); margin-bottom: 12px; text-transform: uppercase; }
.settings-section { margin-bottom: 28px; }
.danger-btn { background: var(--red-light); color: var(--red); border: 1px solid #f0c8c4; }
</style>
</head>
<body>

<nav>
  <div class="logo">GOAL<em>flow</em></div>
  <div class="nav-right">
    <button class="btn-settings" onclick="showPage('settings')">è®¾ç½®</button>
  </div>
</nav>

<div id="page-home" class="page page-wrap active">
  <p class="mono-label">æˆ‘çš„è®¡åˆ’</p>
  <h1 class="serif-title">æ¬¢è¿å›æ¥</h1>
  <p class="body-sub">åˆ›å»ºæ–°è®¡åˆ’ï¼Œæˆ–ç»§ç»­ä¹‹å‰çš„è®¡åˆ’</p>
  <div id="plansList"></div>
  <button class="btn-primary" onclick="showPage('input')"><span class="loading-dots">åˆ›å»ºæ–°è®¡åˆ’</span></button>
</div>

<div id="page-input" class="page page-wrap">
  <p class="mono-label">æ–°è®¡åˆ’</p>
  <h1 class="serif-title">ä½ æƒ³å®Œæˆ<em>ä»€ä¹ˆ</em>ç›®æ ‡ï¼Ÿ</h1>
  <p class="body-sub">å‘Šè¯‰ AIï¼Œå®ƒæ¥å¸®ä½ æ‹†è§£æ¯ä¸€å¤©</p>
  <div class="field-group">
    <label class="field-label">ç›®æ ‡æè¿°</label>
    <textarea id="inputGoal" class="field-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³åœ¨ä¸€ä¸ªæœˆå†…å­¦ä¼š Python åŸºç¡€"></textarea>
    <div id="inputError" class="error-box" style="display:none"></div>
  </div>
  <div class="field-group">
    <label class="field-label">è®¡åˆ’æ—¶é•¿</label>
    <div class="chips" id="timeChips">
      <div class="chip" data-val="3">3å¤©</div>
      <div class="chip sel" data-val="7">1å‘¨</div>
      <div class="chip" data-val="14">2å‘¨</div>
      <div class="chip" data-val="30">1ä¸ªæœˆ</div>
    </div>
    <div class="time-custom">
      <span>æˆ–ç²¾ç¡®åˆ°</span>
      <input type="number" id="customDays" value="" min="1" max="365" placeholder="7">
      <span>å¤©</span>
    </div>
  </div>
  <div class="field-group">
    <label class="field-label">æ¯å¤©å¯ç”¨æ—¶é—´</label>
    <div class="chips" id="timePerDayChips">
      <div class="chip" data-val="0.5">30åˆ†é’Ÿ</div>
      <div class="chip sel" data-val="1">1å°æ—¶</div>
      <div class="chip" data-val="1.5">1.5å°æ—¶</div>
      <div class="chip" data-val="2">2å°æ—¶+</div>
    </div>
  </div>
  <div class="ai-tip">
    <span class="ai-tip-icon">ğŸ’¡</span>
    <p class="ai-tip-text"><strong>AI ä¼šå¯¹ç›®æ ‡è¿›è¡Œæ‹†è§£</strong>ï¼ŒæŠŠå¤§ç›®æ ‡åˆ†è§£æˆæ¯å¤©å¯æ‰§è¡Œçš„å°ä»»åŠ¡</p>
  </div>
  <button class="btn-primary" id="btnGenOutline" onclick="generateOutline()">ç”Ÿæˆè®¡åˆ’å¤§çº²</button>
  <button class="btn-secondary" onclick="showPage('home')">è¿”å›</button>
</div>

<div id="page-outline" class="page page-wrap">
  <p class="mono-label">AI è§„åˆ’äº†ä½ çš„å­¦ä¹ è·¯å¾„</p>
  <h1 class="serif-title">ç¡®è®¤å¤§çº²å<em>ç”Ÿæˆ</em>æ¯æ—¥è¯¦ç»†ä»»åŠ¡</h1>
  <p class="body-sub">å¯éšæ—¶ä¿®æ”¹</p>
  <div id="outlineContent"></div>
  <div class="ai-tip">
    <span class="ai-tip-icon">ğŸ’¡</span>
    <p class="ai-tip-text"><strong>å¯¹å¤§çº²æ»¡æ„å</strong>ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆè¯¦ç»†æ¯æ—¥ä»»åŠ¡</p>
  </div>
  <button class="btn-primary" id="btnGenTasks" onclick="generateTasks()">ç”Ÿæˆæ¯æ—¥ä»»åŠ¡</button>
  <button class="btn-secondary" onclick="showPage('input')">ä¿®æ”¹ç›®æ ‡</button>
</div>

<div id="page-daily" class="page">
  <div class="progress-wrap">
    <div class="progress-head">
      <div class="progress-goal-title" id="progressGoalTitle"></div>
      <div class="progress-frac" id="progressFrac"></div>
    </div>
    <div class="progress-track"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-sub" id="progressSub"></div>
  </div>
  <div class="day-scroll" id="dayScroll"></div>
  <div class="task-list" id="taskList"></div>
</div>

<div id="page-settings" class="page page-wrap">
  <p class="mono-label">è®¾ç½®</p>
  <h1 class="serif-title">é…ç½®</h1>
  <div class="settings-section">
    <div class="settings-title">API è®¾ç½®</div>
    <label class="field-label">MiniMax API Key</label>
    <input type="password" id="apiKeyInput" class="field-input" placeholder="sk-...">
    <p style="font-size:11px;color:var(--gray-600);margin-top:8px">Key ä»…å­˜å‚¨åœ¨æœ¬è®¾å¤‡</p>
    <button class="btn-primary" onclick="saveApiKey()">ä¿å­˜</button>
  </div>
  <div class="settings-section">
    <div class="settings-title">æ•°æ®</div>
    <button class="btn-secondary danger-btn" onclick="clearAll()">æ¸…é™¤æ‰€æœ‰è®¡åˆ’</button>
  </div>
  <button class="btn-secondary" onclick="showPage('home')">è¿”å›</button>
</div>

<div class="bottom-tabs" id="bottomTabs" style="display:none">
  <div class="tab-btn active" onclick="showPage('home')">
    <span class="tab-icon">ğŸ“‹</span>
    <span class="tab-label">è®¡åˆ’</span>
  </div>
  <div class="tab-btn" onclick="showPage('daily')">
    <span class="tab-icon">ğŸ“…</span>
    <span class="tab-label">æ¯æ—¥</span>
  </div>
  <div class="tab-btn" onclick="showPage('settings')">
    <span class="tab-icon">âš™ï¸</span>
    <span class="tab-label">è®¾ç½®</span>
  </div>
</div>

<script>
// Mobile-optimized: use your existing Worker with CORS fix
const DEFAULT_API_KEY = 'sk-api-U4MBMEMv3b1fmBqCucqMWi4h_2aoXRJq4rCkr1XU0vSKYQmeblDzDHq0GewUrdexvKYUjyUjHDms80lP128omgmSl4qQkaPNogUyxLgczrtIrYhW04yRavg';
const WORKER_URL = 'https://goalflow-proxy.mokscreate.workers.dev';

let state = { plans: [], currentPlanId: null, draft: null };

function save() { localStorage.setItem('gf_state', JSON.stringify(state)); }
function load() {
  const raw = localStorage.getItem('gf_state');
  if (raw) { try { state = JSON.parse(raw); } catch(e) {} }
}
load();

function getApiKey() { return localStorage.getItem('gf_apikey') || DEFAULT_API_KEY; }
function saveApiKey() {
  const k = document.getElementById('apiKeyInput').value.trim();
  if (!k) { alert('è¯·è¾“å…¥ API Key'); return; }
  localStorage.setItem('gf_apikey', k);
  alert('å·²ä¿å­˜');
}

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  const tabMap = { 'home': 0, 'daily': 1, 'settings': 2 };
  if (tabMap[name] !== undefined) {
    document.getElementById('bottomTabs').style.display = 'flex';
    document.querySelectorAll('.tab-btn').forEach((b, i) => { b.classList.toggle('active', i === tabMap[name]); });
    if (name === 'home') renderHome();
    if (name === 'daily') renderDaily();
  } else {
    document.getElementById('bottomTabs').style.display = 'none';
  }
}

function showError(id, msg) { const el = document.getElementById(id); el.textContent = msg; el.style.display = 'block'; }
function hideError(id) { document.getElementById(id).style.display = 'none'; }
function showLoading(title, subtitle) {
  document.querySelector('#page-outline .serif-title').textContent = title;
  document.querySelector('#page-outline .body-sub').textContent = subtitle;
}
function disableBtn(id) { document.getElementById(id).disabled = true; }
function enableBtn(id) { document.getElementById(id).disabled = false; }

document.querySelectorAll('#timeChips .chip').forEach(c => {
  c.addEventListener('click', () => {
    document.querySelectorAll('#timeChips .chip').forEach(x => x.classList.remove('sel'));
    c.classList.add('sel');
    document.getElementById('customDays').value = '';
  });
});
document.querySelectorAll('#timePerDayChips .chip').forEach(c => {
  c.addEventListener('click', () => {
    document.querySelectorAll('#timePerDayChips .chip').forEach(x => x.classList.remove('sel'));
    c.classList.add('sel');
  });
});
document.getElementById('customDays').addEventListener('input', function() {
  document.querySelectorAll('#timeChips .chip').forEach(x => x.classList.remove('sel'));
});

// Mobile fix: Try Worker first, fallback to direct API with no-cors mode
async function callClaude(prompt, systemPrompt) {
  const key = getApiKey();
  if (!key) throw new Error('è¯·å…ˆåœ¨è®¾ç½®é¡µå¡«å†™ API Key');

  // Try your Worker first
  try {
    const workerResp = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        groupId: '2022887234998378913',
        apiKey: key,
        payload: { model: 'MiniMax-Text-01', max_tokens: 4096, messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: prompt }] }
      })
    });
    if (workerResp.ok) {
      const data = await workerResp.json();
      if (data.choices && data.choices[0]) return data.choices[0].message.content;
    }
  } catch(e) { console.log('Worker failed, trying direct...'); }

  // Fallback: Direct API call with no-cors (works but can't read response)
  // This is a limitation - mobile browsers block CORS
  // Best solution: fix your Worker to add CORS headers
  const mode = document.visibilityState === 'hidden' ? 'cors' : 'cors';
  
  // Try with credentials
  const response = await fetch('https://api.minimax.chat/v1/text/chatcompletion_v2', {
    method: 'POST',
    mode: 'cors',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${key}`
    },
    body: JSON.stringify({
      model: 'abab6.5s-chat',
      max_tokens: 4096,
      messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: prompt }]
    })
  });

  if (!response.ok) {
    const err = await response.json().catch(() => ({}));
    throw new Error('APIé”™è¯¯: ' + (err.base_resp?.status_msg || response.statusText));
  }

  const data = await response.json();
  if (!data.choices || !data.choices[0]) throw new Error('è¿”å›æ ¼å¼å¼‚å¸¸');
  return data.choices[0].message.content;
}

async function generateOutline() {
  const goal = document.getElementById('inputGoal').value.trim();
  if (!goal) { showError('inputError', 'è¯·å…ˆå¡«å†™ä½ çš„ç›®æ ‡'); return; }

  const days = parseInt(document.getElementById('customDays').value) || parseInt(document.querySelector('#timeChips .chip.sel')?.dataset.val) || 7;
  const hoursChip = document.querySelector('#timePerDayChips .chip.sel');
  const hours = hoursChip ? parseFloat(hoursChip.dataset.val) : 1;

  state.draft = { goal, days, hoursPerDay: hours, outline: null, tasks: null };

  hideError('inputError');
  showLoading('AI æ­£åœ¨åˆ†æä½ çš„ç›®æ ‡', 'é€šå¸¸éœ€è¦ 10ï½20 ç§’');
  disableBtn('btnGenOutline');

  try {
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹ï¼Œå¸®ç”¨æˆ·åˆ¶å®šå­¦ä¹ è®¡åˆ’ã€‚è¯·åªè¿”å›JSONï¼Œä¸è¦è¿”å›å…¶ä»–ä»»ä½•å†…å®¹ã€‚æ ¼å¼å¦‚ä¸‹ï¼š
{
  "phases": [{"name": "é˜¶æ®µåç§°", "days": 7, "description": "è¿™ä¸ªé˜¶æ®µè¦åšä»€ä¹ˆ", "topics": ["topic1", "topic2"]}],
  "note": "ç»™ç”¨æˆ·çš„ç®€çŸ­è¯´æ˜"
}`;
    const prompt = `ç›®æ ‡ï¼š${goal}\nè®¡åˆ’æ—¶é•¿ï¼š${days}å¤©\næ¯å¤©å­¦ä¹ æ—¶é—´ï¼š${hours}å°æ—¶\nè¯·åˆ¶å®šä¸€ä¸ªå­¦ä¹ è®¡åˆ’å¤§çº²ï¼ŒæŠŠç›®æ ‡åˆ†æˆå¤šä¸ªé˜¶æ®µã€‚`;

    const raw = await callClaude(prompt, systemPrompt);
    const cleaned = raw.replace(/```json|```/g, '').trim();
    const outline = JSON.parse(cleaned);
    state.draft.outline = outline;
    renderOutline();
    showPage('outline');
  } catch(e) {
    showError('inputError', e.message);
  } finally {
    enableBtn('btnGenOutline');
  }
}

function renderOutline() {
  const d = state.draft;
  let html = `<div class="meta-row"><span class="meta-tag">${d.days}å¤©</span><span class="meta-tag">æ¯å¤©${d.hoursPerDay}å°æ—¶</span></div>`;
  (d.outline.phases || []).forEach((phase, i) => {
    html += `<div class="phase-card"><div class="phase-top"><span class="phase-num">PHASE ${i+1}</span><span class="phase-days-badge">${phase.days}å¤©</span></div><div class="phase-name">${phase.name}</div><div class="phase-desc">${phase.description}</div><div class="phase-topics">${(phase.topics || []).map(t => `<span class="topic-tag">${t}</span>`).join('')}</div></div>`;
  });
  if (d.outline.note) html += `<div class="outline-note"><div class="outline-note-label">AI è¯´æ˜</div><div class="outline-note-text">${d.outline.note}</div></div>`;
  document.getElementById('outlineContent').innerHTML = html;
}

async function generateTasks() {
  const d = state.draft;
  showLoading('AI æ­£åœ¨ç”Ÿæˆæ¯æ—¥ä»»åŠ¡', 'éœ€è¦ 15ï½30 ç§’');
  disableBtn('btnGenTasks');

  try {
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹ï¼Œå¸®ç”¨æˆ·åˆ¶å®šæ¯æ—¥å­¦ä¹ ä»»åŠ¡ã€‚è¯·åªè¿”å›JSONã€‚æ ¼å¼ï¼š{"tasks": [{"day": 1, "items": ["ä»»åŠ¡1", "ä»»åŠ¡2"]}]}`;
    const prompt = `ç›®æ ‡ï¼š${d.goal}\nè®¡åˆ’ï¼š${JSON.stringify(d.outline.phases)}\næ€»å¤©æ•°ï¼š${d.days}å¤©\næ¯å¤©æ—¶é—´ï¼š${d.hoursPerDay}å°æ—¶\nè¯·ä¸ºæ¯å¤©ç”Ÿæˆ3-5ä¸ªå…·ä½“çš„å­¦ä¹ ä»»åŠ¡`;

    const raw = await callClaude(prompt, systemPrompt);
    const cleaned = raw.replace(/```json|```/g, '').trim();
    const result = JSON.parse(cleaned);
    
    const plan = { id: Date.now().toString(), goal: d.goal, days: d.days, hoursPerDay: d.hoursPerDay, outline: d.outline, tasks: result.tasks, createdAt: Date.now() };
    state.plans.push(plan);
    state.currentPlanId = plan.id;
    save();
    renderDaily();
    showPage('daily');
  } catch(e) {
    alert('ç”Ÿæˆå¤±è´¥: ' + e.message);
  } finally {
    enableBtn('btnGenTasks');
  }
}

function renderHome() {
  const list = document.getElementById('plansList');
  if (state.plans.length === 0) { list.innerHTML = '<p style="color:var(--gray-400);text-align:center;padding:40px 0">æš‚æ— è®¡åˆ’</p>'; return; }
  let html = '';
  state.plans.slice().reverse().forEach(p => {
    const totalTasks = (p.tasks || []).reduce((sum, d) => sum + (d.items || []).length, 0);
    const doneTasks = (p.tasks || []).reduce((sum, d) => sum + (d.items || []).filter(it => it.done).length, 0);
    const pct = totalTasks ? Math.round(doneTasks / totalTasks * 100) : 0;
    html += `<div class="phase-card" style="cursor:pointer" onclick="openPlan('${p.id}')"><div class="phase-top"><span class="phase-num">${new Date(p.createdAt).toLocaleDateString()}</span><span class="phase-days-badge">${p.days}å¤©</span></div><div class="phase-name">${p.goal}</div><div style="margin-top:10px"><div class="progress-track" style="height:2px"><div class="progress-fill" style="width:${pct}%"></div></div><div class="progress-sub" style="margin-top:4px">${doneTasks}/${totalTasks} ä»»åŠ¡å®Œæˆ</div></div></div>`;
  });
  list.innerHTML = html;
}

function openPlan(id) { state.currentPlanId = id; save(); renderDaily(); showPage('daily'); }
function deletePlan(id) { if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return; state.plans = state.plans.filter(p => p.id !== id); if (state.currentPlanId === id) state.currentPlanId = null; save(); renderHome(); }
function clearAll() { if (!confirm('ç¡®å®šæ¸…é™¤æ‰€æœ‰è®¡åˆ’ï¼Ÿæ— æ³•æ¢å¤ï¼')) return; state = { plans: [], currentPlanId: null, draft: null }; save(); showPage('home'); }
function getPlan() { return state.plans.find(p => p.id === state.currentPlanId); }

function renderDaily() {
  const plan = getPlan();
  if (!plan) { showPage('home'); return; }
  document.getElementById('progressGoalTitle').textContent = plan.goal;
  const totalTasks = (plan.tasks || []).reduce((sum, d) => sum + (d.items || []).length, 0);
  const doneTasks = (plan.tasks || []).reduce((sum, d) => sum + (d.items || []).filter(it => it.done).length, 0);
  const currentDay = plan.tasks?.findIndex(d => !(d.items || []).every(it => it.done)) + 1 || plan.days;
  document.getElementById('progressFrac').textContent = `Day ${currentDay} / ${plan.days}`;
  document.getElementById('progressFill').style.width = (doneTasks / totalTasks * 100) + '%';
  document.getElementById('progressSub').textContent = `${doneTasks} / ${totalTasks} ä»»åŠ¡å®Œæˆ`;
  
  let dayHtml = '';
  plan.tasks?.forEach((d, i) => {
    const done = (d.items || []).filter(it => it.done).length;
    const total = (d.items || []).length;
    const isActive = i + 1 === currentDay;
    dayHtml += `<div class="day-btn ${isActive ? 'active' : ''} ${done === total && total > 0 ? 'done' : ''}" onclick="selectDay(${i})"><span class="day-check"></span><span class="day-num">Day ${d.day}</span><span class="day-date">${done}/${total}</span></div>`;
  });
  document.getElementById('dayScroll').innerHTML = dayHtml;
  renderTasks(currentDay - 1);
}

function selectDay(i) { renderTasks(i); }
function renderTasks(dayIndex) {
  const plan = getPlan();
  const day = plan.tasks?.[dayIndex];
  if (!day) return;
  let html = '';
  (day.items || []).forEach((task, i) => {
    const done = task.done ? 'done' : '';
    html += `<div class="task-item ${done}" onclick="toggleTask(${dayIndex}, ${i})"><div class="task-check"></div><div class="task-text">${task.text || task}</div></div>`;
  });
  document.getElementById('taskList').innerHTML = html;
}

function toggleTask(dayIndex, taskIndex) {
  const plan = getPlan();
  plan.tasks[dayIndex].items[taskIndex].done = !plan.tasks[dayIndex].items[taskIndex].done;
  save();
  renderTasks(dayIndex);
  renderDaily();
}

showPage('home');
</script>
</body>
</html>
